<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cyprus Pet Finder</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4">üá®üáæ Cyprus Pet Finder</h1>

    <form id="petForm" class="bg-white shadow-md rounded p-4 mb-6">
      <div class="mb-4">
        <label class="block mb-1">Type:</label>
        <select id="type" class="w-full border p-2 rounded">
          <option value="missing">Missing</option>
          <option value="found">Found</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block mb-1">Pet Name / Description:</label>
        <input id="description" class="w-full border p-2 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block mb-1">Location Last Seen / Found:</label>
        <input id="location" class="w-full border p-2 rounded" required>
      </div>
      <div class="mb-4">
        <label class="block mb-1">Photo:</label>
        <input type="file" id="photo" accept="image/*" class="w-full" required>
      </div>
      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Submit</button>
    </form>

    <h2 class="text-2xl font-semibold mb-2">üêæ Reported Pets</h2>
    <div id="petsList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBv15j9DyPJW1dEuW0BCHOSucRqqQ988i0",
      authDomain: "cypruspetsfinder.firebaseapp.com",
      databaseURL: "https://cypruspetsfinder-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cypruspetsfinder",
      storageBucket: "cypruspetsfinder.firebasestorage.app",
      messagingSenderId: "758035903846",
      appId: "1:758035903846:web:50fbc079fe8ca10ad1c4a7",
      measurementId: "G-4LWWD4W3F1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const petForm = document.getElementById('petForm');
    const petsList = document.getElementById('petsList');

    petForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const type = document.getElementById('type').value;
      const description = document.getElementById('description').value;
      const location = document.getElementById('location').value;
      const file = document.getElementById('photo').files[0];
      const id = Date.now();
      const safeFileName = encodeURIComponent(`${id}_${file.name}`);

      const ref = storage.ref().child(`pets/${safeFileName}`);
      await ref.put(file);
      const photoURL = await ref.getDownloadURL();

      await db.ref('pets/' + id).set({ type, description, location, photoURL });
      petForm.reset();
    });

    db.ref('pets').on('value', (snapshot) => {
      petsList.innerHTML = '';
      const pets = snapshot.val();
      for (const id in pets) {
        const pet = pets[id];
        const isFound = pet.type.toLowerCase() === 'found';
        const isMissingDesc = !pet.description || pet.description.trim() === '';

        const typeLabel = isFound ? '<span class="text-green-600 font-bold">Found</span>' : '<span class="text-red-600 font-bold">Missing</span>';

        const buttonClass = isFound
          ? 'bg-green-500 cursor-default'
          : isMissingDesc
          ? 'bg-gray-400 cursor-not-allowed'
          : 'bg-yellow-500 hover:bg-yellow-600';

        const buttonLabel = isFound ? '‚úÖ Already Found' : 'Mark as Found ‚úÖ';

        const contactInfo = pet.contact ? `<p><strong>Contact:</strong> ${pet.contact}</p>` : '';

        const card = document.createElement('div');
        card.className = 'bg-white shadow rounded p-4';
        card.innerHTML = `
          <img src="${pet.photoURL}" alt="Pet" class="w-full h-48 object-cover rounded mb-2">
          <p>${typeLabel}</p>
          <p><strong>Description:</strong> ${pet.description}</p>
          <p><strong>Location:</strong> ${pet.location}</p>
          ${contactInfo}
          <button class="mt-2 text-white px-3 py-1 rounded mark-found ${buttonClass}" data-id="${id}">${buttonLabel}</button>
        `;
        petsList.appendChild(card);

        const markButton = card.querySelector('.mark-found');
        if (isFound || isMissingDesc) {
          markButton.disabled = true;
        } else {
          markButton.addEventListener('click', async () => {
            const contact = prompt("Enter your contact information so people can reach you:");
            if (contact) {
              await db.ref('pets/' + id).update({ type: 'found', contact });
              markButton.disabled = true;
              markButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
              markButton.classList.add('bg-green-500', 'cursor-default');
              markButton.innerText = '‚úÖ Already Found';
              card.querySelector('p').innerHTML = '<span class="text-green-600 font-bold">Found</span>';
              const contactElem = document.createElement('p');
              contactElem.innerHTML = `<strong>Contact:</strong> ${contact}`;
              card.insertBefore(contactElem, markButton);
            }
          });
        }
      }
    });
  </script>
</body>
</html>
